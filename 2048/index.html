<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/css?family=Ubuntu&display=swap" rel="stylesheet">
    <title>2048 Game</title>
    <style>
        canvas {
            border: 1px solid grey;
        }
    </style>
</head>
<body>
    <canvas width="600" height="600">

    </canvas>
</body>
<script>
    try {
        void (function () {
            const canvas = document.getElementsByTagName("canvas")[0];
            const ctx = canvas.getContext("2d");
            const ws = new WebSocket("wss://game.pls.today");
            const states = {
                WAITING: 0x0,
                INGAME:  0x1,
                P1:      0x2,
                P2:      0x4
            };
            const game = {
                state: states.INGAME | states.P1,
                username: prompt("Username")
            };
            if (game.username === null) {
                ctx.font = "32px Ubuntu";
                return ctx.fillText("No username given", 20, 40);
            }
            const grid = [[],[],[],[]];
            // Init grid
            for (let i = 0; i < 4; ++i) {
                for (let j = 0; j < 4; ++j) {
                    grid[i][j] = 0;
                }
            }
            // Functions
            function drawHeading() {
                ctx.font = "50px Ubuntu";
                ctx.fillText("2048", canvas.width / 2 - 80, 50);
                ctx.fillStyle = "#2ecc71";
                ctx.fillText("MP", canvas.width / 2 + 40, 50);
                ctx.fillStyle = "black";
            }

            function drawWaitingScreen() {
                ctx.font = "35px Ubuntu";
                ctx.fillText("Waiting for another player", 90, canvas.height / 2 - 40);
            }

            function drawGrid() {
                ctx.font = "20px Ubuntu";
                for (let i = 0; i < 4; ++i) { // i = x, j = y
                    for (let j = 0; j < 4; ++j) {
                        ctx.strokeRect(100 + (100 * i), 100 + (100 * j), 100, 100);
                        if (grid[i][j] > 0) ctx.fillText(grid[i][j], 140 + (100 * i), 160 + (100 * j));
                    }
                }
                ctx.stroke();
            }

            function showButtons() {
                ctx.fillStyle = "#3498db";
                ctx.fillRect(40, canvas.height - 50, 150, 40);
                ctx.fillStyle = "white";
                ctx.fillText("How to play", 60, canvas.height - 23);
                ctx.fillStyle = "#3498db";
                ctx.fillRect(canvas.width - 190, canvas.height - 50, 150, 40);
                ctx.fillStyle = "white";
                ctx.fillText("Leave", canvas.width - 140, canvas.height - 23); // change this thing
                ctx.fillStyle = "black";
            }

            function loop() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                drawHeading();

                if (game.state === states.WAITING) {
                    drawWaitingScreen();
                } else {
                    drawGrid();
                    showButtons();
                }

                window.requestAnimationFrame(loop);
            }

            window.requestAnimationFrame(loop);
        })();
    } catch(e) {
        alert(e.toString());
    }
</script>
</html>